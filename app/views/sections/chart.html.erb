<h1><%= @section.name.presence || "セクション#{@section.id}" %> のグラフ</h1>

<!-- ✅ 1. CDNでChart.jsを読み込む（importmapを使わない方式） -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<h2>カテゴリー別 合計時間（分）</h2>
<canvas id="categoryPieChart"></canvas>

<h2>行動の時間推移</h2>
<canvas id="timelineBarChart"></canvas>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // ✅ Chart.js が window.Chart として必ず使える

    // --- 円グラフデータ ---
    const categoryLabels = <%= raw @category_data.keys.to_json %>;
    const categoryValues = <%= raw @category_data.values.to_json %>;

    const ctxPie = document.getElementById("categoryPieChart");
    new Chart(ctxPie, {
      type: "pie",
      data: {
        labels: categoryLabels,
        datasets: [{
          data: categoryValues,
          backgroundColor: [
            "rgba(255,99,132,0.6)",
            "rgba(54,162,235,0.6)",
            "rgba(255,206,86,0.6)",
            "rgba(75,192,192,0.6)",
            "rgba(153,102,255,0.6)"
          ]
        }]
      }
    });

    // --- 棒グラフデータ ---
    const timelineLabels = <%= raw @actions.map { |a| a.started_at.strftime("%H:%M") }.to_json %>;
    const timelineValues = <%= raw @actions.map(&:duration_minutes).to_json %>;

    const ctxBar = document.getElementById("timelineBarChart");
    new Chart(ctxBar, {
      type: "bar",
      data: {
        labels: timelineLabels,
        datasets: [{
          label: "行動時間（分）",
          data: timelineValues,
          backgroundColor: 'rgba(54, 162, 235, 0.6)'
        }]
      }
    });
  });
</script>


<%= link_to "フィードバックに戻る", feedbacks_path, class: "btn btn-secondary" %>
